<template>
  <div
    :class='["affiliate content-glass", child ? "child" : "", firstChild ? "first-child" : "", lastChild ? "last-child" : ""]'
  >
    <div class='aff-top'>
      <h3 class='aff-name'>
        {{ username }}
      </h3>
      <span class='aff-email'>{{ referral?.EmailAddress?.length > 0 ? referral?.EmailAddress : referral?.PhoneNO }}</span>
      <span>{{ $t('MSG_ONBOARDED_USERS') }}:<span class='aff-number'>{{ util.getLocaleString(referral.TotalInvitees)
      }}</span></span>
    </div>
    <div class='aff-table'>
      <table id='commission-table'>
        <thead>
          <tr>
            <th><span>{{ $t('MSG_PRODUCT') }}</span></th>
            <th>
              <div class='tooltip'>
                <span>{{ $t('MSG_COMMISSION_RATE') }}</span>
              </div>
            </th>
            <th>
              <div class='tooltip'>
                <span>{{ $t('MSG_REFERRAL_UNITS') }}</span>
              </div>
            </th>
            <th>
              <div class='tooltip'>
                <span>{{ $t('MSG_TOTAL_SALES') }}</span>
              </div>
            </th>
            <th>
              <div class='tooltip'>
                <span>{{ $t('MSG_REFERRAL_COMMISSION') }} </span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class='aff-info' v-for='(_good, idx) in visibleGoodAchievements' :key='idx'>
            <td>
              <span
                class='aff-product'
                v-html='getDisplayNames(_good.GoodID)?.[4] ? $t(getDisplayNames(_good.GoodID)?.[4] as string) : _good.GoodName'
              />
            </td>
            <td v-if='_good.Editing'>
              <KolOption v-model:percent='_good.CommissionValue' :max='getGoodCommissionValue(_good.GoodID)' />
              <button @click='onSaveCommissionClick(_good)'>
                {{ $t('MSG_SAVE') }}
              </button>
            </td>
            <td v-else>
              <span class='aff-number'>{{ _good.CommissionValue }}<span class='unit'>%</span></span>
              <button
                v-if='child'
                :class='["alt", !good.enableSetCommission(_good.GoodID) || !good.haveSale(good.getGoodByID(_good.GoodID) as AppGood) ? "in-active" : ""]'
                :disabled='!good.enableSetCommission(_good.GoodID) || !good.haveSale(good.getGoodByID(_good.GoodID) as AppGood)'
                @click='(_good.Editing = true)'
              >
                {{ $t('MSG_SET') }}
              </button>
            </td>
            <td>
              <span class='aff-number'>{{ util.getLocaleString(_good.TotalUnits) }}<span class='unit'>{{
                _good.GoodUnit?.length ? $t(_good.GoodUnit) : '' }}</span></span>
            </td>
            <td>
              <span class='aff-number'>{{ util.getLocaleString(Math.floor(Number(_good.TotalAmount) * 100) / 100, 2)
              }}<span class='unit'>{{ PriceCoinName }}</span></span>
            </td>
            <td>
              <span class='aff-number'>
                {{ child ? (_good.SuperiorCommission ? util.getLocaleString(Math.floor(Number(_good.SuperiorCommission) *
                  100) / 100, 2) : "0.00") : util.getLocaleString(Math.floor(Number(_good.TotalCommission) * 100) / 100, 2)
                }}
                <span class='unit'>{{ PriceCoinName }}</span>
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <q-slide-transition>
      <div class='detailed-summary' v-show='showDetailSummary'>
        <h4>{{ $t('MSG_COMMISSION_HISTORY') }}</h4>
        <div class='aff-table'>
          <table id='history-table'>
            <thead>
              <tr>
                <th>{{ $t('MSG_PRODUCT') }}</th>
                <th>{{ $t('MSG_EFFECTIVE_DATE') }}</th>
                <th>{{ $t('MSG_COMMISSION_RATE') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr class='aff-info' v-for='__commission in commissions' :key='__commission.ID'>
                <td>
                  <span
                    class='aff-product'
                    v-html='getDisplayNames(__commission.GoodID)?.[4] ? $t(getDisplayNames(__commission.GoodID)?.[4] as string) : good.getGoodByID(__commission.GoodID)?.GoodName'
                  />
                </td>
                <td>
                  <span class='aff-number'>{{ _commission.settingDate(__commission) }}<span class='unit'>{{
                    _commission.settingTime(__commission) }}</span></span>
                </td>
                <td><span class='aff-number'>{{ __commission.AmountOrPercent }}<span class='unit'>%</span></span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </q-slide-transition>
    <div class='buttons'>
      <button :class='["alt show-more", showDetailSummary ? "open" : ""]' @click='onShowMoreClick'>
        <img :src='chevrons'>
      </button>
    </div>
  </div>
</template>

<script setup lang='ts'>
import {
  PriceCoinName
} from 'npool-cli-v2'
import { ref, toRef, defineProps, computed, defineAsyncComponent } from 'vue'
import chevrons from '../../assets/chevrons.svg'
import {
  useBaseUserStore,
  useLocalUserStore,
  User,
  useAdminAppGoodStore,
  NotifyType,
  AppGood,
  useLocaleStringStore
} from 'npool-cli-v4'
import { useI18n } from 'vue-i18n'
import { MyGoodAchievement } from 'src/localstore/ledger/types'
import { commission, achievement } from 'src/teststore'

// eslint-disable-next-line @typescript-eslint/unbound-method
const { locale, t } = useI18n({ useScope: 'global' })

const KolOption = defineAsyncComponent(() => import('src/components/affiliates/KolOption.vue'))

interface Props {
  child: boolean
  firstChild: boolean
  lastChild: boolean
  referral: achievement.Achievement
}

const props = defineProps<Props>()
const child = toRef(props, 'child')
const firstChild = toRef(props, 'firstChild')
const lastChild = toRef(props, 'lastChild')
const target = toRef(props, 'referral')
const referral = ref(target.value)

const util = useLocaleStringStore()

const baseUser = useBaseUserStore()
const username = computed(() => baseUser.displayName({
  FirstName: referral.value.FirstName,
  LastName: referral.value.LastName
} as User, locale.value as string))

const logined = useLocalUserStore()

const good = useAdminAppGoodStore()
const getDisplayNames = computed(() => (goodID: string) => good.getGoodByID(goodID)?.DisplayNames)

const _achievement = achievement.useAchievementStore()
const goodAchievements = computed(() => Array.from(referral.value?.Achievements.filter((el) => {
  return good.visible(el.GoodID)
})).sort((a, b) => a.GoodName.localeCompare(b.GoodName, 'zh-CN')).map((el) => {
  return {
    ...el,
    Editing: false
  } as MyGoodAchievement
}))
const visibleGoodAchievements = ref(goodAchievements.value)
const getGoodCommissionValue = computed(() => (goodID: string) => {
  return Number(_achievement.inviterGoodCommissionValue(logined?.User.ID, goodID))
})
const getGoodCommissionSettleMode = computed(() => (goodID: string) => {
  return _achievement.inviterGoodCommissionSettleMode(logined?.User.ID, goodID) as commission.SettleMode
})
const getGoodCommissionSettleAmountType = computed(() => (goodID: string) => {
  return _achievement.inviterGoodCommissionSettleAmountType(logined?.User.ID, goodID) as commission.SettleAmountType
})
const getGoodCommissionSettleInterval = computed(() => (goodID: string) => {
  return _achievement.inviterGoodCommissionSettleInterval(logined?.User.ID, goodID) as commission.SettleInterval
})
const getGoodCommissionThreshold = computed(() => (goodID: string) => {
  return _achievement.inviterGoodCommissionThreshold(logined?.User.ID, goodID)
})

const showDetailSummary = ref(false)
const onShowMoreClick = () => {
  showDetailSummary.value = !showDetailSummary.value
}

const _commission = commission.useCommissionStore()
const commissions = computed(() => _commission.Commissions.filter((el) => {
  return el.UserID === referral.value.UserID
}).sort((a, b) => {
  return a.StartAt < b.StartAt ? 1 : -1
}))

const onSaveCommissionClick = (row: MyGoodAchievement) => {
  if (Number(row.CommissionValue) > getGoodCommissionValue.value(row.GoodID)) {
    row.CommissionValue = getGoodCommissionValue.value(row.GoodID).toString()
  }
  if (Number(row.CommissionValue) < 0) {
    row.CommissionValue = '0'
  }

  row.Editing = false
  _commission.createCommission({
    TargetUserID: referral.value.UserID,
    GoodID: row.GoodID,
    SettleType: commission.SettleType.GoodOrderPayment,
    SettleAmountType: getGoodCommissionSettleAmountType.value(row.GoodID),
    SettleMode: getGoodCommissionSettleMode.value(row.GoodID),
    SettleInterval: getGoodCommissionSettleInterval.value(row.GoodID),
    Threshold: getGoodCommissionThreshold.value(row.GoodID),
    AmountOrPercent: `${row.CommissionValue}`,
    StartAt: Math.ceil(Date.now() / 1000),
    Message: {
      Error: {
        Title: t('MSG_CREATE_COMMISSION_FAIL'),
        Popup: true,
        Type: NotifyType.Error
      }
    }
  }, () => {
    // TODO
  })
}
</script>
